#! /usr/bin/env node
const fs = require("fs-extra");
const terminalLink = require("terminal-link");
const c = require("chalk");
const ora = require("ora");
const path = require("path");
const execa = require("execa");
const currentPkgJson = require("../package.json");

// Support port

const startApplication = async () => {
  const spinner = ora(
    "Building your application. This may take a few minutes."
  ).start();
  try {
    await execa("npm", ["run", "build:next"]);

    spinner.succeed("App build successfully");
  } catch (_err) {
    const err = _err;
    if (err.failed) {
      spinner.fail("Failed to build application.");
      process.stdout.write("\n");
      return;
    }
    throw err;
  }
};

(async () => {
  console.log(`âœ¨ You're about to run Hadmean v${currentPkgJson.version}`);

  await fs.copyFile(
    path.join(process.cwd(), "./.env.example"),
    path.join(process.cwd(), "./.env.local")
  );

  process.stdout.write("\n");

  await startApplication();

  process.stdout.write("\n");

  console.log(`ðŸŽ‰ ${terminalLink(
    "Open the application",
    "http://localhost:3000"
  )}

    ${c.bold("Next steps:")}

    - Edit the generated ${c.bold(`.env.local`)} to your desire.

    - ${terminalLink(
      "Know all you can do with Hadmean",
      "https://docs.hadmean.com"
    )}

    - ${terminalLink(
      "Star Hadmean on GitHub",
      "https://github.com/hadmean/hadmean"
    )}
  `);

  await execa("npm", ["run", "start"]);
})().catch((err) => {
  console.error(err);
  process.exit(1);
});
